<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reliable Recursive List Editor (OPML)</title>

<style>
html, body { margin: 0; padding: 0; }
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #fff;
  user-select: none;
}
header {
  display: flex;
  gap: calc(0.5rem * var(--menu-scale));
  padding: 0.5rem;
  border-bottom: 1px solid #ddd;
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 2;
}
header button {
  transform: scale(var(--menu-scale));
  transform-origin: top left;
  flex: var(--menu-flex);
}
h2 { padding: 0.5rem; margin: 0; border-bottom: 1px solid #ddd; }
ul { list-style: none; margin: 0; padding: 0; }
li {
  font-size: 1.8rem;
  padding: 1rem;
  border-bottom: 1px solid #ddd;
  display: flex;
  justify-content: space-between;
  align-items: center;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
li.reordering { opacity: 0.6; background: #f0f0f0; }
.show-children-btn { transform: scale(2); transform-origin: center; }
#sheet {
  position: fixed;
  left: 0; right: 0; bottom: 0;
  background: #fff;
  border-top: 1px solid #ddd;
  transform: translateY(100%);
  transition: transform 0.25s ease;
  padding: 1rem;
  z-index: 3;
}
#sheet.open { transform: translateY(0); }
#sheet button {
  width: 100%;
  font-size: 1.2rem;
  padding: 0.8rem;
  margin-bottom: 0.5rem;
}
</style>
</head>

<body>

<header>
  <button onclick="goBack()">‚¨Ö Back</button>
  <button onclick="addItem()">Ôºã Add</button>
  <button onclick="paste()">üìã Paste</button>
  <button onclick="safeLoadOPML()">üìÇ Load</button>
  <button onclick="safeSaveOPML()">üíæ Save</button>
</header>

<h2 id="parent-name">ROOT</h2>
<ul id="list"></ul>

<div id="sheet">
  <button onclick="editSelected()">‚úèÔ∏è Edit</button>
  <button onclick="addChildSelected()">Ôºã Add child</button>
  <button onclick="pasteAsChildSelected()">üìã Paste as child</button>
  <button onclick="safeExportBranch()">‚¨á Export branch</button>
  <button onclick="safeImportBranch()">‚¨Ü Import branch as child</button>
  <button onclick="cutSelected()">‚úÇ Cut</button>
  <button onclick="deleteSelected()">üóë Delete</button>
  <button onclick="closeSheet()">Cancel</button>
</div>

<!-- Optional modules -->
<script src="files.js"></script>
<script src="webstorage.js"></script>

<script>
/* ============================================================
   SAFETY GUARDS
   ============================================================ */
function unavailable() { alert("Option not available"); }

const safeLoadOPML     = () => window.loadOPML     ? loadOPML()     : unavailable();
const safeSaveOPML     = () => window.saveOPML     ? saveOPML()     : unavailable();
const safeExportBranch = () => window.exportBranch ? exportBranch() : unavailable();
const safeImportBranch = () => window.importBranch ? importBranch() : unavailable();
const safeScheduleSave = () => window.scheduleSave ? scheduleSave() : null;

/* ============================================================
   MENU SCALE
   ============================================================ */
const menuButtonScale = 1.15;
document.documentElement.style.setProperty("--menu-scale", menuButtonScale);
document.documentElement.style.setProperty("--menu-flex", menuButtonScale);

/* ============================================================
   DATA MODEL
   ============================================================ */
let idCounter = 1;
function createNode(text) { return { id: "n" + idCounter++, text, children: [] }; }

const root = { id: "root", text: "ROOT", children: [] };
for (let i=1;i<=15;i++) root.children.push(createNode("Item "+i));

let currentNode = root;
let parentMap = new Map();
let clipboard = null;

/* ============================================================
   STATE + GESTURE
   ============================================================ */
let state = "idle"; // idle | actionSheet | reorder
let selectedNode = null;
let selectedSiblings = null;
const gesture = { node: null, siblings: null };
const LONG_PRESS_MS = 600;
let longPressTimer = null;

/* ============================================================
   RENDER
   ============================================================ */
const ul = document.getElementById("list");
const sheet = document.getElementById("sheet");

function render(nodes){
  document.getElementById("parent-name").textContent =
    currentNode===root ? "ROOT" : currentNode.text;
  ul.innerHTML = "";
  nodes.forEach(node=>{
    parentMap.set(node,currentNode);
    const li = document.createElement("li");
    li.textContent = node.text;

    if(node.children.length){
      const btn = document.createElement("button");
      btn.textContent="‚ñ∂";
      btn.className="show-children-btn";
      btn.onclick = e=>{ e.stopPropagation(); currentNode=node; render(node.children); };
      li.appendChild(btn);
    }

    // ---- touch handling ----
    li.addEventListener("touchstart", e=>{
      if(e.target.tagName==="BUTTON") return;

      if(e.touches.length===2){
        state="reorder";
        gesture.node=node;
        gesture.siblings=nodes;
        li.classList.add("reordering");
        return;
      }

      longPressTimer = setTimeout(()=>{
        state="actionSheet";
        selectedNode=node;
        selectedSiblings=nodes;
        openSheet();
      }, LONG_PRESS_MS);
    });

    li.addEventListener("touchmove", e=>{
      clearTimeout(longPressTimer);
      if(state!=="reorder" || e.touches.length!==2) return;
      e.preventDefault();
      const y=e.touches[0].clientY;
      const from=nodes.indexOf(node);
      const to=indexFromY(y);
      if(from!==to){
        moveItem(nodes,from,to);
        render(nodes);
        safeScheduleSave();
      }
    });

    li.addEventListener("touchend", e=>{
      clearTimeout(longPressTimer);
      if(state==="reorder") li.classList.remove("reordering");
      state="idle";
    });

    li.addEventListener("touchcancel", ()=>{
      clearTimeout(longPressTimer);
      if(state==="reorder") li.classList.remove("reordering");
      state="idle";
    });

    ul.appendChild(li);
  });
}

/* ============================================================
   HELPERS
   ============================================================ */
function indexFromY(y){
  return [...ul.children].findIndex(li=>y<li.getBoundingClientRect().top+li.offsetHeight/2);
}
function moveItem(arr,from,to){ const [x]=arr.splice(from,1); arr.splice(to,0,x); }

/* ============================================================
   MUTATIONS
   ============================================================ */
function addItem(){ const t=prompt("New item"); if(!t)return; currentNode.children.push(createNode(t)); render(currentNode.children); safeScheduleSave(); }
function addChildSelected(){ const t=prompt("New child"); if(!t)return; selectedNode.children.push(createNode(t)); closeSheet(); render(currentNode.children); safeScheduleSave(); }
function paste(){ if(!clipboard)return; currentNode.children.push(clipboard); clipboard=null; render(currentNode.children); safeScheduleSave(); }
function pasteAsChildSelected(){ if(!clipboard)return; selectedNode.children.push(clipboard); clipboard=null; closeSheet(); render(currentNode.children); safeScheduleSave(); }
function cutSelected(){ clipboard=selectedNode; selectedSiblings.splice(selectedSiblings.indexOf(selectedNode),1); closeSheet(); render(currentNode.children); safeScheduleSave(); }
function deleteSelected(){ selectedSiblings.splice(selectedSiblings.indexOf(selectedNode),1); closeSheet(); render(currentNode.children); safeScheduleSave(); }
function editSelected(){ const t=prompt("Edit",selectedNode.text); if(t!==null)selectedNode.text=t; closeSheet(); render(currentNode.children); safeScheduleSave(); }
function goBack(){ if(currentNode===root) return; currentNode=parentMap.get(currentNode); render(currentNode.children); }

/* ============================================================
   UI HELPERS
   ============================================================ */
function openSheet(){ sheet.classList.add("open"); }
function closeSheet(){ sheet.classList.remove("open"); }

/* ============================================================
   INIT
   ============================================================ */
(async ()=>{
  if(window.loadState) await loadState();
  render(currentNode.children);
})();
</script>

</body>
</html>
